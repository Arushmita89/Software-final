<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Patient Dashboard - Mental Health Care System</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f0f4f8;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 32px 8px;
    }
    .dashboard {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(15,23,42,0.16);
      max-width: 1280px;
      width: 100%;
      min-height: 80vh;
      padding: 28px 32px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .header h1 {
      margin: 0;
      color: #1e293b;
      font-size: 22px;
    }
    .header span {
      font-size: 13px;
      color: #64748b;
    }
    .tabs {
      display: flex;
      gap: 8px;
      border-bottom: 1px solid #e2e8f0;
      margin-bottom: 16px;
    }
    .tab-btn {
      padding: 8px 16px;
      border-radius: 999px 999px 0 0;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 14px;
      color: #475569;
    }
    .tab-btn.active {
      background: #2563eb;
      color: #ffffff;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #0f172a;
      margin: 8px 0 12px;
    }
    .card {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px 14px;
      margin-bottom: 10px;
      background: #f9fafb;
      font-size: 14px;
      color: #0f172a;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px 20px;
    }
    label {
      display: block;
      margin: 6px 0 2px;
      font-size: 13px;
      color: #111827;
    }
    input, select, textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 4px;
      border: 1px solid #cbd5e1;
      font-size: 13px;
      resize: vertical;
    }
    button {
      margin-top: 10px;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      background: #2563eb;
      color: #ffffff;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #1d4ed8;
    }
    .message {
      margin-top: 8px;
      font-size: 13px;
      color: #15803d;
    }
    .error {
      color: #b91c1c;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 6px;
    }
    th, td {
      border: 1px solid #e2e8f0;
      padding: 6px 8px;
      text-align: left;
    }
    th {
      background: #eff6ff;
      color: #1e293b;
    }
    .status-badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      display: inline-block;
    }
    .status-Pending { background:#fee2e2; color:#b91c1c; }
    .status-Checked-in { background:#fef3c7; color:#92400e; }
    .status-Completed { background:#dcfce7; color:#166534; }
    .status-Cancelled { background:#e5e7eb; color:#374151; }
  </style>
</head>
<body>
  <div class="dashboard">
    <div class="header">
      <div>
        <h1>Patient Dashboard</h1>
        <span id="patientInfo">Logged in as Patient</span>
      </div>
      <button onclick="localStorage.removeItem('currentPatientId'); window.location.href='/index.html';">
        Logout
      </button>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="overview">Overview</button>
      <button class="tab-btn" data-tab="appointments">Appointments</button>
      <button class="tab-btn" data-tab="payments">Payments</button>
      <button class="tab-btn" data-tab="feedback">Feedback</button>
    </div>

    <!-- OVERVIEW TAB -->
    <div id="overview" class="tab-content active">
      <div class="section-title">Profile & Prescriptions</div>
      <div class="grid-2">
        <div class="card">
          <strong>Patient Details</strong><br>
          <span id="ovName">Name: Demo Patient</span><br>
          <span id="ovId">Patient ID: P001</span><br>
          <span id="ovEmail">Email: demo@example.com</span><br>
          <span id="ovPhone">Phone: 9876543210</span>
        </div>
        <div class="card">
          <strong>Upcoming Appointments</strong>
          <ul id="nextApptList" style="padding-left:18px; margin:8px 0 0;">
            <li>No upcoming appointment scheduled.</li>
          </ul>
        </div>
      </div>

      <div class="section-title" style="margin-top:18px;">Prescriptions</div>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Doctor</th>
            <th>Medicine</th>
            <th>Dosage</th>
            <th>Instructions</th>
          </tr>
        </thead>
        <tbody id="prescriptionBody"></tbody>
      </table>
    </div>

    <!-- APPOINTMENTS TAB -->
  <div id="appointments" class="tab-content">
    <div class="section-title">Schedule New Appointment</div>
    <div class="grid-2">
      <div>
        <label for="fullName">Full Name</label>
        <input type="text" id="fullName" placeholder="Enter full name">

        <label for="contact">Email or Phone</label>
        <input type="text" id="contact" placeholder="Enter email or 10-digit phone">

        <label for="apptSpec">Select Specialization</label>
        <select id="apptSpec">
          <option value="">-- Choose specialization --</option>
        </select>

        <label for="apptDoctor">Select Doctor</label>
        <select id="apptDoctor">
          <option value="">-- Choose doctor --</option>
        </select>

        <label for="apptDate">Date</label>
        <input type="date" id="apptDate">

        <label for="apptTime">Available Time Slots</label>
        <select id="apptTime">
          <option value="">-- Select time slot --</option>
        </select>

        <label for="apptReason">Reason for visit</label>
        <textarea id="apptReason" rows="3"></textarea>

        <button id="bookBtn">Book Appointment</button>
        <div id="apptMsg" class="message"></div>
      </div>

      <div>
        <div class="section-title">Your Appointments</div>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Date</th>
              <th>Time</th>
              <th>Doctor</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="apptTableBody"></tbody>
        </table>

        <div class="section-title">Next Upcoming Appointment</div>
        <ul id="nextApptList"></ul>
      </div>
    </div>
  </div>

    <!-- PAYMENTS TAB -->
    <div id="payments" class="tab-content">
      <div class="section-title">Pay for Appointment</div>
      <label for="payApptId">Appointment ID</label>
      <input type="text" id="payApptId" placeholder="Enter Appointment ID">

      <label for="payMethod">Payment Method</label>
      <select id="payMethod">
        <option value="UPI">UPI</option>
        <option value="Card">Card</option>
        <option value="Net Banking">Net Banking</option>
        <option value="Cash at clinic">Cash at clinic</option>
      </select>

      <label for="payAmount">Amount</label>
      <input type="number" id="payAmount" placeholder="₹">

      <button id="payBtn">Make Payment</button>
      <div id="payMsg" class="message"></div>

      <div class="section-title" style="margin-top:18px;">Payment History</div>
      <table>
        <thead>
          <tr>
            <th>Appointment ID</th>
            <th>Date</th>
            <th>Method</th>
            <th>Amount</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="payTableBody"></tbody>
      </table>
    </div>

    <!-- FEEDBACK TAB -->
    <div id="feedback" class="tab-content">
      <div class="section-title">Provide Feedback</div>

      <label for="fbDoctor">Select Doctor</label>
      <select id="fbDoctor">
        <option value="">-- Choose doctor --</option>
      </select>

      <label for="fbRating">Rating (1 = Poor, 5 = Excellent)</label>
      <select id="fbRating">
        <option value="">-- Select rating --</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>

      <label for="fbComments">Additional Comments</label>
      <textarea id="fbComments" rows="4"></textarea>

      <button id="fbBtn">Submit Feedback</button>
      <div id="fbMsg" class="message"></div>

      <div class="section-title" style="margin-top:18px;">Previous Feedback</div>
      <div id="fbList"></div>
    </div>
  </div>

  <script>
    // ----- basic patient info -----
    const currentPatientId = localStorage.getItem("currentPatientId");
    const allPatientsForDash = JSON.parse(localStorage.getItem("patients") || "{}");
    const currentPatient = currentPatientId ? allPatientsForDash[currentPatientId] : null;

    if (currentPatient) {
      document.getElementById("patientInfo").textContent =
        "Logged in as " + currentPatient.name + " (Patient ID: " + currentPatientId + ")";
      document.getElementById("ovName").textContent = "Name: " + currentPatient.name;
      document.getElementById("ovId").textContent = "Patient ID: " + currentPatientId;
      document.getElementById("ovEmail").textContent = "Email: " + currentPatient.email;
      document.getElementById("ovPhone").textContent = "Phone: " + currentPatient.contact;
    } else {
      document.getElementById("patientInfo").textContent =
        "No active patient session. Please log in again.";
    }

    // ----- tabs -----
    const tabs = document.querySelectorAll(".tab-btn");
    const contents = document.querySelectorAll(".tab-content");
    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        const target = tab.dataset.tab;
        tabs.forEach(t => t.classList.remove("active"));
        contents.forEach(c => c.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(target).classList.add("active");
      });
    });

    // ----- shared data -----
    let appointments = JSON.parse(localStorage.getItem("appointments") || "[]");
    let payments = [];
    let feedbacks = JSON.parse(localStorage.getItem("feedbacks") || "[]");
    const doctors = JSON.parse(localStorage.getItem("doctors") || "[]");

    function saveAppointments() {
      localStorage.setItem("appointments", JSON.stringify(appointments));
    }
    function saveFeedbacks() {
      localStorage.setItem("feedbacks", JSON.stringify(feedbacks));
    }

    // ----- dynamic specialization & doctors -----
    const specSelect   = document.getElementById("apptSpec");
    const doctorSelect = document.getElementById("apptDoctor");
    const timeSelect   = document.getElementById("apptTime");
    const dateInput    = document.getElementById("apptDate");
    const fbDoctor     = document.getElementById("fbDoctor");

    const specSet = new Set();
    doctors.forEach(d => {
      if (d.spec) specSet.add(d.spec);
    });

    specSet.forEach(spec => {
      const opt = document.createElement("option");
      opt.value = spec;
      opt.textContent = spec;
      specSelect.appendChild(opt);
    });

    function doctorLabel(d) {
      return d.name + " , " + d.spec;
    }

    specSelect.addEventListener("change", () => {
      const spec = specSelect.value;
      doctorSelect.innerHTML = "<option value=''>-- Choose doctor --</option>";
      timeSelect.innerHTML   = "<option value=''>-- Select time slot --</option>";
      doctors
        .filter(d => !spec || d.spec === spec)
        .forEach(d => {
          const label = doctorLabel(d);
          const opt = document.createElement("option");
          opt.value = label;
          opt.textContent = label;
          doctorSelect.appendChild(opt);
        });
    });

    // feedback doctor list
    fbDoctor.innerHTML = "<option value=''>-- Choose doctor --</option>";
    doctors.forEach(d => {
      const label = doctorLabel(d);
      const opt = document.createElement("option");
      opt.value = label;
      opt.textContent = label;
      fbDoctor.appendChild(opt);
    });

    // ----- time slots -----
    const allSlots = [
      "10:00", "10:30", "11:00", "11:30",
      "12:00", "12:30", "13:00", "13:30",
      "14:00", "14:30", "15:00", "15:30", "16:00"
    ];

    function refreshPatientSlots() {
      timeSelect.innerHTML = "<option value=''>-- Select time slot --</option>";
      const doctor = doctorSelect.value;
      const date   = dateInput.value;
      if (!doctor || !date) return;

      const booked = appointments
  .filter(a => a.doctor === doctor && a.date === date && a.status !== "Cancelled")
  .map(a => a.time);

      const freeSlots = allSlots.filter(t => !booked.includes(t));
      freeSlots.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        timeSelect.appendChild(opt);
      });
    }

    doctorSelect.addEventListener("change", refreshPatientSlots);
    dateInput.addEventListener("change", refreshPatientSlots);

    function statusClass(status) {
      if (status === "Checked-in") return "status-Checked-in";
      if (status === "Completed")  return "status-Completed";
      if (status === "Cancelled")  return "status-Cancelled";
      return "status-Pending";
    }

    // ----- Save appointments (simulate localStorage) -----
    function saveAppointments() {
      // localStorage.setItem("appointments", JSON.stringify(appointments));
      console.log("Appointments saved:", appointments);
    }

    function statusClass(status) {
      return status || "Pending";
    }

    // ----- Render appointments table -----
    function renderAppointments() {
      const body = document.getElementById("apptTableBody");
      body.innerHTML = "";

      const myList = appointments
        .filter(a => a.patientId === currentPatientId)
        .sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));

      if (myList.length === 0) {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 6;
        cell.textContent = "No appointments yet.";
        row.appendChild(cell);
        body.appendChild(row);

        const ul = document.getElementById("nextApptList");
        ul.innerHTML = "";
        const li = document.createElement("li");
        li.textContent = "No upcoming appointment scheduled.";
        ul.appendChild(li);
        return;
      }

      myList.forEach(appt => {
        const st = appt.status || "Pending";
        const row = document.createElement("tr");
        row.innerHTML =
          "<td>" + appt.id + "</td>" +
          "<td>" + appt.date + "</td>" +
          "<td>" + appt.time + "</td>" +
          "<td>" + appt.doctor + "</td>" +
          "<td><span class='status-badge " + statusClass(st) + "'>" +
          st + "</span></td>" +
          "<td><button data-id='" + appt.id + "' class='cancelBtn'" +
          (st === "Completed" || st === "Cancelled" ? " disabled" : "") +
          ">Cancel</button></td>";
        body.appendChild(row);
      });

      const todayStr = new Date().toISOString().slice(0, 10);
      const upcomingList = myList
        .filter(a => (a.status === "Pending" || a.status === "Checked-in" || !a.status) &&
                     a.date >= todayStr)
        .sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));

      const upcomingUl = document.getElementById("nextApptList");
      upcomingUl.innerHTML = "";
      if (upcomingList.length === 0) {
        const li = document.createElement("li");
        li.textContent = "No upcoming appointment scheduled.";
        upcomingUl.appendChild(li);
      } else {
        upcomingList.forEach(a => {
          const li = document.createElement("li");
          li.textContent = a.date + " " + a.time + " with " + a.doctor;
          upcomingUl.appendChild(li);
        });
      }

      document.querySelectorAll(".cancelBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const appt = appointments.find(a => a.id === id);
          if (!appt) return;
          if (appt.status === "Completed" || appt.status === "Cancelled") return;
          appt.status = "Cancelled";
          appt.cancelledBy = "patient";
          saveAppointments();
          renderAppointments();
        });
      });
    }

    // ----- Book new appointment -----
    document.getElementById("bookBtn").addEventListener("click", () => {
      const name = document.getElementById("fullName").value.trim();
      const contact = document.getElementById("contact").value.trim();
      const doctor = document.getElementById("apptDoctor").value;
      const date = document.getElementById("apptDate").value;
      const time = document.getElementById("apptTime").value;
      const reason = document.getElementById("apptReason").value.trim();
      const msgDiv = document.getElementById("apptMsg");

      // --- Reset message ---
  msgDiv.textContent = "";
  msgDiv.classList.remove("error");
  msgDiv.style.color = "";

      // --- Validation ---
      if (!name) {
        msgDiv.textContent = "Full Name cannot be empty.";
        msgDiv.style.color = "red";
        return;
      }

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const phoneRegex = /^\d{10}$/;
      if (!emailRegex.test(contact) && !phoneRegex.test(contact)) {
        msgDiv.textContent = "Invalid contact. Please enter a valid email or phone number.";
        msgDiv.style.color = "red";
        return;
      }

      if (!doctor) {
        msgDiv.textContent = "Please select a therapist before booking.";
        msgDiv.style.color = "red";
        return;
      }

      const todayStr = new Date().toISOString().slice(0, 10);
      if (!date || date < todayStr) {
        msgDiv.textContent = "Invalid date. Please choose a future date.";
        msgDiv.style.color = "red";
        return;
      }

      if (!time) {
        msgDiv.textContent = "Please select a time slot.";
        msgDiv.style.color = "red";
        return;
      }

      // --- All good, create appointment ---
      const newAppt = {
        id: "A" + (appointments.length + 1),
        patientId: currentPatientId,
        patientName: name,
        contact: contact,
        doctor: doctor,
        date: date,
        time: time,
        reason: reason,
        status: "Pending",
      };

      appointments.push(newAppt);
      saveAppointments();
      renderAppointments();

      msgDiv.textContent = `Appointment successfully booked. Confirmation details sent to ${contact}.`;
      msgDiv.style.color = "green";

      // Reset form
      document.getElementById("apptDoctor").value = "";
      document.getElementById("apptDate").value = "";
      document.getElementById("apptTime").value = "";
      document.getElementById("apptReason").value = "";
    });

    // ----- Initialize render -----
    renderAppointments();

    // ----- prescriptions -----
    function renderPrescriptions() {
      const body = document.getElementById("prescriptionBody");
      body.innerHTML = "";

      if (!currentPatientId) {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 6;
        cell.textContent = "Please log in again to view prescriptions.";
        row.appendChild(cell);
        body.appendChild(row);
        return;
      }

      const raw = localStorage.getItem("prescriptionsByPatient");
      if (!raw) {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 6;
        cell.textContent = "No prescriptions available yet.";
        row.appendChild(cell);
        body.appendChild(row);
        return;
      }

      let allPres = {};
      try { allPres = JSON.parse(raw); } catch (e) { allPres = {}; }

      const list = allPres[currentPatientId] || [];
      if (list.length === 0) {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 6;
        cell.textContent = "No prescriptions available yet.";
        row.appendChild(cell);
        body.appendChild(row);
        return;
      }

      list.forEach(p => {
        const meds = p.medicines || [];
        const medsNames  = meds.map(m => m.name).join(", ");
        const medsDosage = meds.map(m => m.dosage || "").join(", ");
        const medsInstr  = meds.map(m => m.instructions || "").join(", ");

        const row = document.createElement("tr");
        row.innerHTML =
          "<td>" + p.date + "</td>" +
          "<td>" + (p.time || "") + "</td>" +
          "<td>" + p.doctor + "</td>" +
          "<td>" + medsNames  + "</td>" +
          "<td>" + medsDosage + "</td>" +
          "<td>" + medsInstr  + "</td>";
        body.appendChild(row);
      });
    }

    document.getElementById("bookBtn").addEventListener("click", () => {
  const name = document.getElementById("fullName").value.trim();
  const contact = document.getElementById("contact").value.trim();
  const doctor = document.getElementById("apptDoctor").value;
  const date = document.getElementById("apptDate").value;
  const time = document.getElementById("apptTime").value;
  const reason = document.getElementById("apptReason").value.trim();
  const msgDiv = document.getElementById("apptMsg");

  // --- Reset message ---
  msgDiv.textContent = "";
  msgDiv.classList.remove("error");
  msgDiv.style.color = "";

  // --- Validation ---
  if (!name) {
    msgDiv.textContent = "Full Name cannot be empty.";
    msgDiv.classList.add("error");
    return;
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const phoneRegex = /^\d{10}$/;
  if (!emailRegex.test(contact) && !phoneRegex.test(contact)) {
    msgDiv.textContent = "Invalid contact. Please enter a valid email or phone number.";
    msgDiv.classList.add("error");
    return;
  }

  if (!doctor) {
    msgDiv.textContent = "Please select a therapist before booking.";
    msgDiv.classList.add("error");
    return;
  }

  if (!date) {
    msgDiv.textContent = "Please select a date.";
    msgDiv.classList.add("error");
    return;
  }

  const todayStr = new Date().toISOString().slice(0, 10);
  if (date < todayStr) {
    msgDiv.textContent = "Invalid date. Please choose a future date.";
    msgDiv.classList.add("error");
    return;
  }

  if (!time) {
    msgDiv.textContent = "Please select a time slot.";
    msgDiv.classList.add("error");
    return;
  }

  // --- Create appointment ---
  const newAppt = {
    id: "A" + (appointments.length + 1),
    patientId: currentPatientId,
    patientName: name,
    contact: contact,
    doctor: doctor,
    date: date,
    time: time,
    reason: reason,
    status: "Pending",
  };

  appointments.push(newAppt);
  saveAppointments();
  renderAppointments();

  // --- Success message ---
  msgDiv.textContent = `Appointment successfully booked. Confirmation details sent to ${contact}.`;
  msgDiv.style.color = "green";

  // --- Reset form fields ---
  document.getElementById("apptDoctor").value = "";
  document.getElementById("apptDate").value = "";
  document.getElementById("apptTime").value = "";
  document.getElementById("apptReason").value = "";
});


    // ----- download invoice -----
    function downloadInvoice(payment) {
      const appt = appointments.find(a => a.id === payment.apptId);
      if (!appt || !currentPatient) return;

      const invoiceWindow = window.open("", "_blank");

      invoiceWindow.document.write(`
        <html>
        <head>
          <title>Invoice - ${payment.apptId}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 30px; color: #0f172a; }
            h2 { text-align: center; margin-bottom: 20px; }
            .box { border: 1px solid #cbd5e1; padding: 16px; border-radius: 8px; }
            .row { margin-bottom: 8px; }
            .label { font-weight: bold; }
            .footer { margin-top: 24px; text-align: center; font-size: 12px; color: #64748b; }
          </style>
        </head>
        <body>
          <h2>Payment Invoice</h2>

          <div class="box">
            <div class="row"><span class="label">Invoice Date:</span> ${payment.date}</div>
            <div class="row"><span class="label">Appointment ID:</span> ${payment.apptId}</div>
            <div class="row"><span class="label">Patient Name:</span> ${currentPatient.name}</div>
            <div class="row"><span class="label">Doctor:</span> ${appt.doctor}</div>
            <div class="row"><span class="label">Appointment Date:</span> ${appt.date}</div>
            <div class="row"><span class="label">Time:</span> ${appt.time}</div>
            <div class="row"><span class="label">Payment Method:</span> ${payment.method}</div>
            <div class="row"><span class="label">Amount Paid:</span> ₹${payment.amount}</div>
            <div class="row"><span class="label">Status:</span> ${payment.status}</div>
          </div>

          <div class="footer">
            Mental Health Care System<br>
            This is a system-generated invoice.
          </div>

          <script>
            window.onload = function() { window.print(); };
          <\/script>
        </body>
        </html>
      `);

      invoiceWindow.document.close();
    }

    // ----- payments -----
    function renderPayments() {
      const body = document.getElementById("payTableBody");
      body.innerHTML = "";
      if (payments.length === 0) {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 5;
        cell.textContent = "No payments recorded.";
        row.appendChild(cell);
        body.appendChild(row);
        return;
      }
      payments.forEach(p => {
        const row = document.createElement("tr");
        row.innerHTML =
          "<td>" + p.apptId + "</td>" +
          "<td>" + p.date   + "</td>" +
          "<td>" + p.method + "</td>" +
          "<td>" + p.amount + "</td>" +
          "<td>" + p.status +
          " <br><button onclick='downloadInvoice(" + JSON.stringify(p) + ")'>Download Invoice</button></td>";
        body.appendChild(row);
      });
    }

    document.getElementById("payBtn").onclick = function () {
      const apptId = document.getElementById("payApptId").value.trim();
      const method = document.getElementById("payMethod").value;
      const amount = document.getElementById("payAmount").value.trim();
      const msg    = document.getElementById("payMsg");
      msg.classList.remove("error");
      msg.textContent = "";

      if (!apptId || !amount) {
        msg.textContent = "Enter appointment ID and amount.";
        msg.classList.add("error");
        return;
      }
      if (amount <= 0) {
    msg.textContent = "Invalid amount. Amount must be a positive value.";
    msg.classList.add("error");
    return;
  }
      const appt = appointments.find(a => a.id === apptId);
      if (!appt) {
        msg.textContent = "Appointment ID not found.";
        msg.classList.add("error");
        return;
      }

      const payment = {
        apptId,
        date: new Date().toISOString().slice(0, 10),
        method,
        amount,
        status: "Paid"
      };
      payments.push(payment);
      msg.textContent = "Payment recorded for appointment " + apptId + ".";
      document.getElementById("payApptId").value = "";
      document.getElementById("payAmount").value = "";
      renderPayments();
    };

    // ----- feedback (stored for admin) -----
    function renderFeedback() {
      const list = document.getElementById("fbList");
      list.innerHTML = "";
      const mine = feedbacks.filter(f => f.patientId === currentPatientId);
      if (mine.length === 0) {
        list.textContent = "No feedback submitted yet.";
        return;
      }
      mine.forEach(f => {
        const div = document.createElement("div");
        div.className = "card";
        div.textContent =
          f.doctor + " | Rating: " + f.rating + "/5 - " +
          f.comments + " (" + f.date + ")";
        list.appendChild(div);
      });
    }

    document.getElementById("fbBtn").onclick = function () {
      const doctor   = document.getElementById("fbDoctor").value;
      const rating   = document.getElementById("fbRating").value;
      const comments = document.getElementById("fbComments").value.trim();
      const msg      = document.getElementById("fbMsg");
      msg.classList.remove("error");
      msg.textContent = "";

      if (!doctor || !rating || rating < 1 || rating > 5 || !comments) {
        msg.textContent = "Select doctor, rating 1–5 and enter a comment.";
        msg.classList.add("error");
        return;
      }

      if (!currentPatient) {
        msg.textContent = "Patient session not found.";
        msg.classList.add("error");
        return;
      }

      feedbacks.push({
        doctor,
        rating: Number(rating),
        comments,
        date: new Date().toISOString().slice(0, 10),
        patientId: currentPatientId,
        patientName: currentPatient.name
      });
      saveFeedbacks();

      msg.textContent = "Feedback submitted. Thank you.";
      document.getElementById("fbDoctor").value   = "";
      document.getElementById("fbRating").value   = "";
      document.getElementById("fbComments").value = "";
      renderFeedback();
    };

    // ----- initial renders -----
    renderAppointments();
    renderPayments();
    renderFeedback();
    renderPrescriptions();
  </script>
</body>
</html>
